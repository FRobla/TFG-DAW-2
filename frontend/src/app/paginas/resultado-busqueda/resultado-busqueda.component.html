<!-- Usando el componente navbar-busqueda -->
<app-navbar-busqueda></app-navbar-busqueda>
  
<!-- Cabecera de resultados -->
<section class="results-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1>Resultados de búsqueda</h1>
          <p class="results-count">
            Se encontraron <strong>{{totalResultados}}</strong> servicios
            <span *ngIf="terminoBusqueda && terminoBusqueda.trim() !== ''"> para "<span class="search-term">{{terminoBusqueda}}</span>"</span>
          </p>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-md-end mt-3 mt-md-0">
            <div class="dropdown me-2">
              <button class="btn btn-outline-light dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Ordenar por: {{ getTextoOrden() }}
              </button>
              <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="sortDropdown">
                <li><a class="dropdown-item" [class.active]="ordenActual === 'relevancia'" href="javascript:void(0)" (click)="cambiarOrden('relevancia')">Relevancia</a></li>
                <li><a class="dropdown-item" [class.active]="ordenActual === 'precio_asc'" href="javascript:void(0)" (click)="cambiarOrden('precio_asc')">Precio: menor a mayor</a></li>
                <li><a class="dropdown-item" [class.active]="ordenActual === 'precio_desc'" href="javascript:void(0)" (click)="cambiarOrden('precio_desc')">Precio: mayor a menor</a></li>
                <li><a class="dropdown-item" [class.active]="ordenActual === 'fecha_desc'" href="javascript:void(0)" (click)="cambiarOrden('fecha_desc')">Más recientes</a></li>
                <li><a class="dropdown-item" [class.active]="ordenActual === 'fecha_asc'" href="javascript:void(0)" (click)="cambiarOrden('fecha_asc')">Más antiguos</a></li>
                <li><a class="dropdown-item" [class.active]="ordenActual === 'titulo'" href="javascript:void(0)" (click)="cambiarOrden('titulo')">Título A-Z</a></li>
              </ul>
            </div>
            <div class="btn-group" role="group" aria-label="Vista">
              <button type="button" class="btn btn-outline-light" [class.active]="vistaActual === 'grid'" (click)="cambiarVista('grid')">
                <i class="bi bi-grid-3x3-gap-fill"></i>
              </button>
              <button type="button" class="btn btn-outline-light" [class.active]="vistaActual === 'list'" (click)="cambiarVista('list')">
                <i class="bi bi-list"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Contenido principal -->
  <section class="results-content">
    <div class="container">
      <div class="row">
        <!-- Filtros laterales -->
        <div class="col-lg-3 mb-4">
          <div class="filter-card mb-3">
            <div class="filter-header my-1">
              <h3>Filtros</h3>
              <button class="btn btn-sm btn-link" (click)="limpiarFiltros()">Limpiar todos</button>
            </div>
          </div>
          <div class="filter-card">
            <!-- Categorías -->
            <div class="filter-section">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-box2 mb-3"></i>
                <h4>Categoría</h4>
              </div>
              <!-- Mostramos solo las primeras 5 categorías o todas si mostrarTodasCategorias es true -->
              <div class="form-check" *ngFor="let categoria of categoriasConConteo; let i = index" 
                   [hidden]="!mostrarTodasCategorias && i >= 5">
                <input class="form-check-input" type="checkbox" [id]="'cat' + categoria.id" 
                       [checked]="isCategoriaSeleccionada(categoria.id)"
                       (change)="toggleCategoria(categoria.id)">
                <label class="form-check-label" [for]="'cat' + categoria.id">
                  {{categoria.nombre}} ({{categoria.cantidad}})
                </label>
              </div>
              
              <!-- Botón Ver más / Ver menos según el estado actual -->
              <button class="btn btn-sm btn-link d-block mt-2" *ngIf="categoriasConConteo.length > 5" (click)="mostrarTodasCategorias ? verMenosCategorias() : verMasCategorias()">
                {{ mostrarTodasCategorias ? 'Ver menos' : 'Ver más' }}
              </button>
            </div>

            <!-- Material -->
            <div class="filter-section">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-box material mb-2"></i>
                <h4>Material</h4>
              </div>
              <div class="form-check" *ngFor="let material of materiales; let i = index"
                   [hidden]="!mostrarTodosMateriales && i >= 5">
                <input class="form-check-input" type="checkbox" [id]="'mat' + material.id"
                       [checked]="isMaterialSeleccionado(material.id)"
                       (change)="toggleMaterial(material.id)">
                <label class="form-check-label" [for]="'mat' + material.id">
                  {{material.nombre}} ({{material.cantidad}})
                </label>
              </div>
              <!-- Botón Ver más / Ver menos según el estado actual -->
              <button class="btn btn-sm btn-link d-block mt-2" *ngIf="materiales.length > 5" (click)="mostrarTodosMateriales ? verMenosMateriales() : verMasMateriales()">
                {{ mostrarTodosMateriales ? 'Ver menos' : 'Ver más' }}
              </button>
            </div>
            
            <!-- Valoración -->
            <div class="filter-section">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-star mb-3"></i>
                <h4>Valoración</h4>
              </div>
              <div class="form-check" *ngFor="let valoracion of valoraciones">
                <input class="form-check-input" type="checkbox" [id]="'rate' + valoracion.id"
                       [checked]="isValoracionSeleccionada(valoracion.id)"
                       (change)="toggleValoracion(valoracion.id)">
                <label class="form-check-label d-flex align-items-center" [for]="'rate' + valoracion.id">
                  <span class="rating me-2">{{ '★'.repeat(valoracion.estrellas) }}</span> ({{valoracion.cantidad}})
                </label>
              </div>
            </div>
            
            <!-- Precio -->
            <div class="filter-section">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-cash-coin mb-2"></i>
                <h4>Precio</h4>
              </div>
              <div class="price-inputs d-flex flex-column mt-2">
                <div class="input-group input-group-sm mb-2">
                  <span class="input-group-text">Min</span>
                  <input type="number" class="form-control" placeholder="€" 
                         [(ngModel)]="filtroPrecioMin" 
                         (blur)="aplicarFiltroPrecio()"
                         (keyup.enter)="aplicarFiltroPrecio()">
                </div>
                <div class="input-group input-group-sm">
                  <span class="input-group-text">Max</span>
                  <input type="number" class="form-control" placeholder="€" 
                         [(ngModel)]="filtroPrecioMax"
                         (blur)="aplicarFiltroPrecio()"
                         (keyup.enter)="aplicarFiltroPrecio()">
                </div>
              </div>
            </div>

            <!-- Ubicación -->
            <div class="filter-section">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-geo-alt mb-3"></i>
                <h4>Ubicación</h4>
              </div>
              <div class="form-check" *ngFor="let ubicacion of ubicaciones; let i = index"
                   [hidden]="!mostrarTodasUbicaciones && i >= 5">
                <input class="form-check-input" type="checkbox" [id]="'loc' + ubicacion.id"
                       [checked]="isUbicacionSeleccionada(ubicacion.id)"
                       (change)="toggleUbicacion(ubicacion.id)">
                <label class="form-check-label" [for]="'loc' + ubicacion.id">
                  {{ubicacion.nombre}} ({{ubicacion.cantidad}})
                </label>
              </div>
              <!-- Botón Ver más / Ver menos según el estado actual -->
              <button class="btn btn-sm btn-link d-block mt-2" *ngIf="ubicaciones.length > 5" (click)="mostrarTodasUbicaciones ? verMenosUbicaciones() : verMasUbicaciones()">
                {{ mostrarTodasUbicaciones ? 'Ver menos' : 'Ver más' }}
              </button>
            </div>

            <!-- Tiempo de entrega -->
            <div class="filter-section">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-clock reloj mb-2"></i>
                <h4>Tiempo de entrega</h4>
              </div>
              <div class="form-check" *ngFor="let tiempo of tiemposEntrega; let i = index"
                   [hidden]="!mostrarTodosTiempos && i >= 4">
                <input class="form-check-input" type="checkbox" [id]="'time' + tiempo.id"
                       [checked]="isTiempoEntregaSeleccionado(tiempo.id)"
                       (change)="toggleTiempoEntrega(tiempo.id)">
                <label class="form-check-label" [for]="'time' + tiempo.id">
                  {{tiempo.nombre}} ({{tiempo.cantidad}})
                </label>
              </div>
              <!-- Botón Ver más / Ver menos según el estado actual -->
              <button class="btn btn-sm btn-link d-block mt-2" *ngIf="tiemposEntrega.length > 3" (click)="mostrarTodosTiempos ? verMenosTiempos() : verMasTiempos()">
                {{ mostrarTodosTiempos ? 'Ver menos' : 'Ver más' }}
              </button>
            </div>
          </div>
        </div>
        
        <!-- Resultados de búsqueda -->
        <div class="col-lg-9">
          <!-- Chips de filtros activos -->
          <div class="active-filters mb-4" *ngIf="categoriaSeleccionadas.length > 0 || ubicacionesSeleccionadas.length > 0 || valoracionesSeleccionadas.length > 0 || materialesSeleccionados.length > 0 || tiemposEntregaSeleccionados.length > 0">
            <!-- Chips para categorías seleccionadas -->
            <span class="filter-chip gap-1" *ngFor="let categoriaId of categoriaSeleccionadas">
            <i class="bi bi-box2 mx-1"></i>{{ getNombreCategoria(categoriaId) }} <button class="btn-close btn-close-white ms-2" (click)="eliminarFiltroCategoria(categoriaId)" aria-label="Close"></button>
            </span>
            
            <!-- Chips para ubicaciones seleccionadas -->
            <span class="filter-chip gap-1" *ngFor="let ubicacionId of ubicacionesSeleccionadas">
            <i class="bi bi-geo-alt mx-1"></i>{{ getNombreUbicacion(ubicacionId) }} <button class="btn-close btn-close-white ms-2" (click)="eliminarFiltroUbicacion(ubicacionId)" aria-label="Close"></button>
            </span>
            
            <!-- Chips para valoraciones seleccionadas -->
            <span class="filter-chip gap-1" *ngFor="let valoracionId of valoracionesSeleccionadas">
            <i class="bi bi-star mx-1"></i>{{ getValoracionEstrellas(valoracionId) }} <button class="btn-close btn-close-white ms-2" (click)="eliminarFiltroValoracion(valoracionId)" aria-label="Close"></button>
            </span>
            
            <!-- Chips para materiales seleccionados -->
            <span class="filter-chip gap-1" *ngFor="let materialId of materialesSeleccionados">
            <i class="bi bi-box mx-1"></i>{{ getNombreMaterial(materialId) }} <button class="btn-close btn-close-white ms-2" (click)="eliminarFiltroMaterial(materialId)" aria-label="Close"></button>
            </span>
            
            <!-- Chips para tiempos de entrega seleccionados -->
            <span class="filter-chip gap-1" *ngFor="let tiempoId of tiemposEntregaSeleccionados">
            <i class="bi bi-clock mx-1"></i> {{ getNombreTiempoEntrega(tiempoId) }} <button class="btn-close btn-close-white ms-2" (click)="eliminarFiltroTiempoEntrega(tiempoId)" aria-label="Close"></button>
            </span>
            
            <!-- Botón para limpiar todos los filtros -->
            <button class="btn btn-sm btn-outline-light ms-2" (click)="limpiarFiltros()">Limpiar todos</button>
          </div>
          
          <!-- Grid de servicios -->
          <!-- Indicador de carga -->
          <div class="text-center py-5" *ngIf="cargando">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Buscando anuncios...</p>
          </div>

          <!-- Mensaje cuando no hay resultados -->
          <div class="text-center py-5" *ngIf="!cargando && resultados.length === 0">
            <i class="bi bi-search display-4 text-muted"></i>
            <h4 class="mt-3">No se encontraron resultados</h4>
            <p class="text-muted">Intenta ajustar tus filtros de búsqueda o utiliza términos más generales.</p>
            <button class="btn btn-primary" (click)="limpiarFiltros()">Limpiar filtros</button>
          </div>

          <!-- Grid de anuncios dinámicos -->
          <div class="row g-4" data-view-transition="card" *ngIf="!cargando && resultados.length > 0">
            <div class="col-md-6 col-lg-4" *ngFor="let anuncio of resultados; let i = index">
              <div class="service-card" data-view-transition="card">
                <div class="service-badge" *ngIf="anuncio.estado === 'activo'">Activo</div>
                <div class="service-badge" *ngIf="anuncio.vistas && anuncio.vistas > 500" style="background-color: #3a3a3a;">Popular</div>
                
                <div class="service-image" data-view-transition="image" [attr.data-view-id]="'anuncio-img-' + anuncio.id">
                  <img *ngIf="anuncio.urlImagen" [src]="anuncio.urlImagen" [alt]="anuncio.titulo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                  <!-- SVG por defecto si no hay imagen -->
                  <svg *ngIf="!anuncio.urlImagen" viewBox="0 0 100 100" width="100" height="100">
                    <rect x="20" y="20" width="60" height="60" fill="none" stroke="#FFFFFF" stroke-width="2"/>
                    <path d="M30,50 L70,50 M50,30 L50,70" stroke="#FFFFFF" stroke-width="2"/>
                  </svg>
                </div>
                
                <h3 data-view-transition="header" [attr.data-view-id]="'anuncio-title-' + anuncio.id">{{ anuncio.titulo }}</h3>
                
                <div class="service-provider">
                  <span class="provider-name">{{ anuncio.getNombreUsuario() }}</span>
                  <div class="rating">
                    <span>★★★★☆</span>
                    <span class="rating-count">({{ anuncio.vistas || 0 }})</span>
                  </div>
                </div>
                
                <p class="service-description">{{ anuncio.descripcion }}</p>
                
                <div class="service-meta">
                  <div class="service-location" *ngIf="anuncio.usuario && anuncio.usuario.direccion">
                    <i class="bi bi-geo-alt"></i> {{ anuncio.usuario.direccion }}
                  </div>
                  <div class="service-delivery" *ngIf="anuncio.tiempoEstimado">
                    <i class="bi bi-clock"></i> {{ anuncio.tiempoEstimado }}
                  </div>
                </div>
                
                <div class="service-price">
                  <span>Desde {{ anuncio.getPrecioFormateado() }}</span>
                </div>
                
                <button class="btn btn-cta w-100" (click)="verDetalles(anuncio.id)">Ver detalles</button>
              </div>
            </div>
          </div>
          
          <!-- Paginación -->
          <div class="pagination-container mt-5" *ngIf="!cargando && resultados.length > 0 && totalPaginas > 1">
            <nav aria-label="Navegación de resultados">
              <ul class="pagination justify-content-center">
                <li class="page-item" [class.disabled]="primeraPagina">
                  <a class="page-link" href="javascript:void(0)" (click)="paginaAnterior()" 
                     [attr.tabindex]="primeraPagina ? -1 : null" 
                     [attr.aria-disabled]="primeraPagina">Anterior</a>
                </li>
                
                <li class="page-item" *ngFor="let pagina of getPaginasArray()" 
                    [class.active]="pagina === paginaActual">
                  <a class="page-link" href="javascript:void(0)" (click)="cambiarPagina(pagina)">{{ pagina }}</a>
                </li>
                
                <li class="page-item" [class.disabled]="ultimaPagina">
                  <a class="page-link" href="javascript:void(0)" (click)="paginaSiguiente()"
                     [attr.tabindex]="ultimaPagina ? -1 : null"
                     [attr.aria-disabled]="ultimaPagina">Siguiente</a>
                </li>
              </ul>
            </nav>
            
            <!-- Información de paginación -->
            <div class="pagination-info text-center mt-3">
              <small class="text-muted">
                Mostrando {{ (paginaActual - 1) * resultadosPorPagina + 1 }} - 
                {{ Math.min(paginaActual * resultadosPorPagina, totalResultados) }} 
                de {{ totalResultados }} resultados
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  
<!-- Footer -->
<app-footer></app-footer>