<!-- Usando el componente navbar-busqueda -->
<app-navbar-busqueda></app-navbar-busqueda>

<div class="perfil-container">
  <!-- Header del perfil -->
  <div class="perfil-header">
    <div class="container">
      <div class="perfil-header-content">
        <div class="avatar-section">
          <div class="avatar-wrapper">
            <div class="avatar-large" 
                 [style.background-image]="usuario.fotoPerfil ? 'url(' + usuario.fotoPerfil + ')' : ''"
                 data-view-transition="avatar">
              <span *ngIf="!usuario.fotoPerfil" class="avatar-initials">{{getIniciales()}}</span>
            </div>
            <button class="avatar-edit-btn" (click)="abrirModalFoto()" title="Cambiar foto de perfil">
              <i class="fas fa-camera"></i>
            </button>
          </div>
        </div>
        <div class="perfil-info">
          <h1 class="perfil-nombre" data-view-transition="title">{{usuario.nombre}} {{usuario.apellido}}</h1>
          <p class="perfil-email">{{usuario.email}}</p>
          <div class="perfil-meta">
            <span class="role-badge" [ngClass]="{'admin-role': usuario.rol === 'ADMIN', 'user-role': usuario.rol === 'USER'}">
              <i class="fas" [class.fa-shield-alt]="usuario.rol === 'ADMIN'" [class.fa-user]="usuario.rol === 'USER'"></i>
              {{usuario.rol}}
            </span>
            <span class="fecha-registro">
              <i class="fas fa-calendar-alt"></i>
              Miembro desde {{getFechaRegistroFormateada()}}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="perfil-content">
    <div class="container">
      <div class="row">
        <!-- Sidebar de navegación -->
        <div class="col-lg-3 col-md-4">
          <div class="perfil-nav">
            <h3>Mi Perfil</h3>
            <div class="nav-items">
              <div class="nav-item active">
                <i class="fas fa-user"></i>
                <span>Información Personal</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Contenido principal -->
        <div class="col-lg-9 col-md-8">
          <div class="perfil-sections">
            
            <!-- Sección Datos Personales -->
            <div class="perfil-section" data-view-transition="card">
              <div class="section-header">
                <div class="section-title">
                  <i class="fas fa-user-circle"></i>
                  <h3>Datos Personales</h3>
                </div>
                <button class="btn-edit" (click)="abrirModalDatosPersonales()">
                  <i class="fas fa-edit"></i>
                  Editar
                </button>
              </div>
              <div class="section-content">
                <div class="info-grid">
                  <div class="info-item">
                    <label>Nombre</label>
                    <span>{{usuario.nombre || 'No especificado'}}</span>
                  </div>
                  <div class="info-item">
                    <label>Apellido</label>
                    <span>{{usuario.apellido || 'No especificado'}}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sección Información de Contacto -->
            <div class="perfil-section" data-view-transition="card">
              <div class="section-header">
                <div class="section-title">
                  <i class="fas fa-envelope"></i>
                  <h3>Información de Contacto</h3>
                </div>
                <button class="btn-edit" (click)="abrirModalContacto()">
                  <i class="fas fa-edit"></i>
                  Editar
                </button>
              </div>
              <div class="section-content">
                <div class="info-grid">
                  <div class="info-item">
                    <label>Email</label>
                    <span>{{usuario.email || 'No especificado'}}</span>
                  </div>
                  <div class="info-item">
                    <label>Dirección</label>
                    <span>{{usuario.direccion || 'No especificada'}}</span>
                  </div>
                  <div class="info-item">
                    <label>Ciudad</label>
                    <span>{{usuario.getNombreUbicacion()}}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sección Seguridad -->
            <div class="perfil-section" data-view-transition="card">
              <div class="section-header">
                <div class="section-title">
                  <i class="fas fa-shield-alt"></i>
                  <h3>Seguridad</h3>
                </div>
                <button class="btn-edit" (click)="abrirModalSeguridad()">
                  <i class="fas fa-key"></i>
                  Cambiar Contraseña
                </button>
              </div>
              <div class="section-content">
                <div class="info-item">
                  <label>Contraseña</label>
                  <span>••••••••••••</span>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Indicador de carga -->
<div *ngIf="cargando" class="loading-overlay" data-view-transition="loading-indicator">
  <div class="loading-content">
    <div class="spinner"></div>
    <p>Cargando perfil...</p>
  </div>
</div>

<!-- Modal Datos Personales -->
<div class="modal" [class.active]="modalDatosPersonalesVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Editar Datos Personales</h2>
      <button class="close-btn" (click)="cerrarModalDatosPersonales()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form #datosPersonalesForm="ngForm">
        <div class="form-group">
          <label for="nombre">Nombre *</label>
          <input type="text" 
                 id="nombre" 
                 name="nombre" 
                 [(ngModel)]="usuarioEditado.nombre" 
                 required
                 minlength="2"
                 #nombreInput="ngModel"
                 [class.invalid]="nombreInput.invalid && nombreInput.touched">
          <div class="error-message" *ngIf="nombreInput.invalid && nombreInput.touched">
            <span *ngIf="nombreInput.errors?.['required']">El nombre es obligatorio</span>
            <span *ngIf="nombreInput.errors?.['minlength']">El nombre debe tener al menos 2 caracteres</span>
          </div>
        </div>
        <div class="form-group">
          <label for="apellido">Apellido *</label>
          <input type="text" 
                 id="apellido" 
                 name="apellido" 
                 [(ngModel)]="usuarioEditado.apellido" 
                 required
                 #apellidoInput="ngModel"
                 [class.invalid]="apellidoInput.invalid && apellidoInput.touched">
          <div class="error-message" *ngIf="apellidoInput.invalid && apellidoInput.touched">
            El apellido es obligatorio
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalDatosPersonales()">
        Cancelar
      </button>
      <button class="btn btn-primary" 
              (click)="guardarDatosPersonales()"
              [disabled]="datosPersonalesForm.invalid">
        Guardar Cambios
      </button>
    </div>
  </div>
</div>

<!-- Modal Información de Contacto -->
<div class="modal" [class.active]="modalContactoVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Editar Información de Contacto</h2>
      <button class="close-btn" (click)="cerrarModalContacto()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form #contactoForm="ngForm">
        <div class="form-group">
          <label for="email">Email *</label>
          <input type="email" 
                 id="email" 
                 name="email" 
                 [(ngModel)]="usuarioEditado.email" 
                 required
                 email
                 #emailInput="ngModel"
                 [class.invalid]="emailInput.invalid && emailInput.touched">
          <div class="error-message" *ngIf="emailInput.invalid && emailInput.touched">
            <span *ngIf="emailInput.errors?.['required']">El email es obligatorio</span>
            <span *ngIf="emailInput.errors?.['email']">Introduzca un email válido</span>
          </div>
        </div>
        <div class="form-group">
          <label for="direccion">Dirección</label>
          <input type="text" 
                 id="direccion" 
                 name="direccion" 
                 [(ngModel)]="usuarioEditado.direccion"
                 placeholder="Ej: Calle Principal 123, Ciudad, País">
        </div>
        <div class="form-group">
          <label for="ubicacion">Ciudad</label>
          <select id="ubicacion" 
                  name="ubicacion" 
                  class="form-select"
                  [(ngModel)]="ubicacionSeleccionadaId">
            <option value="">Seleccionar ciudad</option>
            <option *ngFor="let ubicacion of ubicaciones" [value]="ubicacion.id">
              {{ubicacion.nombre}}
            </option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalContacto()">
        Cancelar
      </button>
      <button class="btn btn-primary" 
              (click)="guardarContacto()"
              [disabled]="contactoForm.invalid">
        Guardar Cambios
      </button>
    </div>
  </div>
</div>

<!-- Modal Cambiar Contraseña -->
<div class="modal" [class.active]="modalSeguridadVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Cambiar Contraseña</h2>
      <button class="close-btn" (click)="cerrarModalSeguridad()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form #seguridadForm="ngForm">
        <div class="form-group">
          <label for="passwordActual">Contraseña Actual *</label>
          <input type="password" 
                 id="passwordActual" 
                 name="passwordActual" 
                 [(ngModel)]="passwordActual" 
                 required
                 #passwordActualInput="ngModel"
                 [class.invalid]="passwordActualInput.invalid && passwordActualInput.touched">
          <div class="error-message" *ngIf="passwordActualInput.invalid && passwordActualInput.touched">
            La contraseña actual es obligatoria
          </div>
        </div>
        <div class="form-group">
          <label for="passwordNueva">Nueva Contraseña *</label>
          <input type="password" 
                 id="passwordNueva" 
                 name="passwordNueva" 
                 [(ngModel)]="passwordNueva" 
                 required
                 minlength="6"
                 #passwordNuevaInput="ngModel"
                 [class.invalid]="passwordNuevaInput.invalid && passwordNuevaInput.touched">
          <div class="error-message" *ngIf="passwordNuevaInput.invalid && passwordNuevaInput.touched">
            <span *ngIf="passwordNuevaInput.errors?.['required']">La nueva contraseña es obligatoria</span>
            <span *ngIf="passwordNuevaInput.errors?.['minlength']">La contraseña debe tener al menos 6 caracteres</span>
          </div>
        </div>
        <div class="form-group">
          <label for="passwordConfirmar">Confirmar Nueva Contraseña *</label>
          <input type="password" 
                 id="passwordConfirmar" 
                 name="passwordConfirmar" 
                 [(ngModel)]="passwordConfirmar" 
                 required
                 #passwordConfirmarInput="ngModel"
                 [class.invalid]="passwordConfirmarInput.invalid && passwordConfirmarInput.touched || passwordConfirmar !== passwordNueva">
          <div class="error-message" *ngIf="(passwordConfirmarInput.invalid && passwordConfirmarInput.touched) || (passwordConfirmar !== passwordNueva && passwordConfirmar)">
            <span *ngIf="passwordConfirmarInput.errors?.['required']">Confirma la nueva contraseña</span>
            <span *ngIf="passwordConfirmar !== passwordNueva && passwordConfirmar">Las contraseñas no coinciden</span>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalSeguridad()">
        Cancelar
      </button>
      <button class="btn btn-primary" 
              (click)="cambiarPassword()"
              [disabled]="seguridadForm.invalid || passwordConfirmar !== passwordNueva">
        Cambiar Contraseña
      </button>
    </div>
  </div>
</div>

<!-- Modal Foto de Perfil -->
<div class="modal" [class.active]="modalFotoVisible">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Cambiar Foto de Perfil</h2>
      <button class="close-btn" (click)="cerrarModalFoto()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="foto-upload-section">
        <div class="foto-preview">
          <div class="preview-container">
            <img *ngIf="imagenPreview" [src]="imagenPreview" alt="Preview" class="preview-image">
            <div *ngIf="!imagenPreview" class="preview-placeholder">
              <i class="fas fa-image"></i>
              <p>Vista previa de la imagen</p>
            </div>
          </div>
        </div>
        <div class="upload-controls">
          <input type="file" 
                 #fotoInput
                 id="fotoInput" 
                 accept="image/*" 
                 (change)="onFileSelected($event)"
                 style="display: none;">
          <button class="btn btn-outline" (click)="fotoInput.click()">
            <i class="fas fa-upload"></i>
            Seleccionar Imagen
          </button>
          <p class="upload-info">Formatos soportados: JPG, PNG, GIF. Tamaño máximo: 5MB</p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cerrarModalFoto()">
        Cancelar
      </button>
      <button class="btn btn-primary" 
              (click)="guardarFotoPerfil()"
              [disabled]="!archivoSeleccionado">
        Guardar Foto
      </button>
    </div>
  </div>
</div>
  